#!/system/bin/bash
export TZ=UTC−03:00

PidProcess="/data/trueDT/peer/TMP/init.update.boot.PID"
Log="/data/trueDT/peer/TMP/init.update.boot.LOG"
if [ ! -d "/data/trueDT/peer/TMP" ]; then
	mkdir -p "/data/trueDT/peer/TMP"
fi

# 3 serviços neste script
	# CheckUptimeInternet 
		# (pq se não tiver internet chama o wifi settings para frente uma unica vez apenas no firstboot)
		# deixa a box em loop infinito ate o sinal retornar
	# FORCEClockUpdateNow
		# forca update do time via url proxy
	# ClockUpdateNow
		# NTP update time

# -eq # Equal
# -ne # Not equal
# -lt # Less than
# -le # Less than or equal
# -gt # Greater than
# -ge # Greater than or equal



# se o uptime for abaixo de 150 quer dizer que o boot foi a frio e apaga o marcador
checkUptime=`busybox cat /proc/uptime | busybox cut -d " " -f 2 | busybox cut -d "." -f 1`
if [ "$checkUptime" -le "150" ]; then
	rm "/data/trueDT/peer/TMP/First Cold Boot.log" > /dev/null 2>&1
	echo "ADM DEBUG ##########################################################################################" > "$Log"
	echo "ADM DEBUG ### First Cold Boot Uptime: $(busybox cat /proc/uptime | busybox cut -d " " -f 2 | busybox cut -d "." -f 1)" >> "$Log"
	echo "ADM DEBUG ### $(busybox ps aux | grep "init.update.boot.sh" | busybox grep -v grep)" >> "$Log"
fi

###########################################################################################################################
# declarando as funções

# quando o services chamar este script pode ser que o uptime chegue em media a 74secs. 
# apos entrar dentro deste loop fica parado para não chamar duas vezes
function FNcheckUptime () {
if [ ! -f "/data/trueDT/peer/TMP/First Cold Boot.log" ]; then	
	checkUptime=`busybox cat /proc/uptime | busybox cut -d " " -f 2 | busybox cut -d "." -f 1`
	if [ "$checkUptime" -le "200" ]; then	
		rm "$PidProcess" > /dev/null 2>&1
		rm "/data/trueDT/peer/TMP/NoInternetAccess" > /dev/null 2>&1
		echo "ADM DEBUG ##########################################################################################" >> "$Log"
		echo "ADM DEBUG ### {function FNcheckUptime} " >> "$Log"
		echo "ADM DEBUG ### $(busybox ps aux | grep "init.update.boot.sh" | busybox grep -v grep)" >> "$Log"
		echo "ADM DEBUG ### novo boot a frio" >> "$Log"
		echo "ADM DEBUG ### Tasks one time only" >> "$Log"
		echo "ADM DEBUG ### Box ligada a $checkUptime segundos atras" >> "$Log"
		echo "ADM DEBUG ### BLOQUEANDO O ACESSO ROOT" >> "$Log"
		checkPin=`/system/bin/busybox cat /system/.pin`
		if [ ! "$checkPin" = "FSgfdgkjhç8790d5sdf85sd867f5gs876df5g876sdf5g78s6df5g78s6df5gs87df6g576sfd" ];then
			/system/bin/busybox mount -o remount,rw /system
			echo -n 'FSgfdgkjhç8790d5sdf85sd867f5gs876df5g876sdf5g78s6df5g78s6df5gs87df6g576sfd' > /system/.pin
			chmod 644 /system/.pin
		fi
		# # obrigado a dar este pause no first boot para aguardar as interfaces de rede lan e wlan
		while [[ -z $(getprop sys.boot_completed) ]]; do sleep 1; done;		
		sleep 30		
		# verifica se a box tem internet caso não tenha trava em looping aqui
		echo "ADM DEBUG ##########################################################################################" >> "$Log"
		echo "ADM DEBUG ### Checando acesso a internet" >> "$Log"	
		CheckUptimeInternet
		# update relogio precisa de um tempo para a box iniciar e chamar o ntp client
		# futuro chamar um script ou service separado para update do relogio
		echo "ADM DEBUG ##########################################################################################" >> "$Log"
		echo "ADM DEBUG ### atualizando relogio" >> "$Log"
		ClockUpdateNow
		echo "ADM DEBUG ##########################################################################################" >> "$Log"
		echo "ADM DEBUG ### mensagem de alerta para usuário final no boot a frio" >> "$Log"
		# * carregar um url do telegram e jogar na tela ?
		echo "ADM DEBUG ##########################################################################################" >> "$Log"
		echo "ADM DEBUG ### configurando android settings..." >> "$Log"	
		settings put global heads_up_notifications_enabled 0
		settings put global package_verifier_enable 0
		settings put secure install_non_market_apps 1
		settings put global install_non_market_apps 1
		settings put global policy_control immersive.full=*
		echo "ADM DEBUG ##########################################################################################" >> "$Log"
		echo "ADM DEBUG ### Cold Boot Finished" >> "$Log"	
		echo "Cold Boot Finished! uptime:$(busybox cat /proc/uptime | busybox cut -d " " -f 2 | busybox cut -d "." -f 1) $(busybox date +"%d/%m/%Y %H:%M:%S")" > "/data/trueDT/peer/TMP/First Cold Boot.log"
	fi
fi
}


function CheckUptimeInternet () {
echo "ADM DEBUG ##########################################################################################" >> "$Log"
echo "ADM DEBUG ### {function CheckUptimeInternet} Loop Infinito " >> "$Log"
CheckUptimeInternetlinks="
https://www.google.com
https://ipv4.icanhazip.com
https://www.youtube.com
https://steamcommunity.com
https://stackoverflow.com
https://ntp.br
https://pixkey.net
"
while [ 1 ]; do
	for link in $CheckUptimeInternetlinks; do
		httpcode=`/system/bin/curl -k -o /dev/null --silent --head --write-out '%{http_code}\n' "$link"`
		echo "ADM DEBUG ##########################################################################################" >> "$Log"
		echo "ADM DEBUG ### link     = $link" >> "$Log"
		echo "ADM DEBUG ### httpcode = $httpcode" >> "$Log"
		if [ "$httpcode" == "200" ]; then
			rm "/data/trueDT/peer/TMP/NoInternetAccess" > /dev/null 2>&1
			break;
		else
			echo "ADM DEBUG ### link offline = $link" >> "$Log"
			if [ ! -f "/data/trueDT/peer/TMP/NoInternetAccess" ]; then
				if [ ! -f "/data/trueDT/peer/TMP/FirstSetupWiFi.log" ]; then
					echo "ADM DEBUG ### ativando wifi settings one time only" >> "$Log"
					am start -a com.android.settings -n com.android.settings/com.android.settings.wifi.WifiSettings
					echo "[ NoInternetAccess ] $(busybox date +%s) => $(busybox date +"%d/%m/%Y %H:%M:%S")" > "/data/trueDT/peer/TMP/NoInternetAccess"
					echo "[ NoInternetAccess ] $(busybox date +%s) => $(busybox date +"%d/%m/%Y %H:%M:%S")" > "/data/trueDT/peer/TMP/FirstSetupWiFi.log"
				fi
			fi
		fi;
	done
	if [ "$httpcode" == "200" ]; then break; fi;
	echo "ADM DEBUG ##########################################################################################" >> "$Log"
	echo "ADM DEBUG ### Check internet access: $(busybox date +"%d/%m/%Y %H:%M:%S")" >> "$Log"
	busybox sleep 5;
done;
}


function FORCEClockUpdateNow () {
	while [ 1 ]; do
		echo "ADM DEBUG ##########################################################################################" >> "$Log"
		echo "ADM DEBUG ### {function FORCEClockUpdateNow} " >> "$Log"
		echo "ADM DEBUG ### Start time api free server worldtimeapi.org [ to save bandwidth ]" >> "$Log"
		rawvar=`curl --silent -w "%{http_code}" "http://worldtimeapi.org/api/timezone/America/Sao_Paulo"`
		export httpCode=`echo -n "$rawvar" | busybox cut -d "}" -f 2`
		export unixtime=`echo -n "$rawvar" | busybox cut -d ',' -f 12 | busybox cut -d ':' -f 2`
		echo "ADM DEBUG ### {function worldtimeapi.org} [ before URL time tweak ] $(busybox date +%s) => $(busybox date +"%d/%m/%Y %H:%M:%S")" >> "$Log"
		echo "ADM DEBUG ### $httpCode" >> "$Log"
		echo "ADM DEBUG ### $unixtime" >> "$Log"
		if [ "$httpCode" == "200" ]; then
			/system/bin/busybox date -s "@$unixtime"
			echo "ADM DEBUG ### {function worldtimeapi.org} [ after URL time tweak ] $(busybox date +%s) => $(busybox date +"%d/%m/%Y %H:%M:%S")" >> "$Log"
			break
		fi
		echo "ADM DEBUG ##########################################################################################" >> "$Log"
		echo "ADM DEBUG ### try update via pixkey $(busybox date +"%d/%m/%Y %H:%M:%S")" >> "$Log"
		rawvar=`curl -k --silent -w "%{http_code}" "https://pixkey.net/epochTime.php"`
		export httpCode=`echo -n "$rawvar" | busybox sed -n '3p'`
		export unixtime=`echo -n "$rawvar" | busybox sed -n '2p'`
		echo "ADM DEBUG ### {function FORCEClockUpdateNow} [ before URL time tweak ] $(busybox date +%s) => $(busybox date +"%d/%m/%Y %H:%M:%S")" >> "$Log"
		echo "ADM DEBUG ### $httpCode" >> "$Log"
		echo "ADM DEBUG ### $unixtime" >> "$Log"
		if [ "$httpCode" == "200" ]; then
			/system/bin/busybox date -s "@$unixtime"
			echo "ADM DEBUG ### {function FORCEClockUpdateNow} [ after URL time tweak ] $(busybox date +%s) => $(busybox date +"%d/%m/%Y %H:%M:%S")" >> "$Log"
			break
		fi
		busybox sleep 5;     
	done;
	echo "ADM DEBUG ### [EXIT] {function FORCEClockUpdateNow} $(busybox date +%s) => $(busybox date +"%d/%m/%Y %H:%M:%S")" >> "$Log"
}

# looping do relogio precisa ter um init service separado. não posso obrigar o boot update dos apps ter relógio in sync
# caso a box não atualize o relogio eu perco o cliente, ele nao recebe os apps e tb não chega no chaveamento o script
function ClockUpdateNow () {
	echo "ADM DEBUG ##########################################################################################" >> "$Log"
	echo "ADM DEBUG ### {function ClockUpdateNow} [ NTP Time before tweak ] $(busybox date +"%d/%m/%Y %H:%M:%S")" >> "$Log"
	settings put global ntp_server a.st1.ntp.br 
	settings put global auto_time 0
	settings put global auto_time 1
	echo "ADM DEBUG ### {function ClockUpdateNow} [ NTP Time after tweak ] $(busybox date +"%d/%m/%Y %H:%M:%S")" >> "$Log"
	# caso não atualize via UDP NTP server entra em looping infinito ate conseguir atualizar o horario
	# -eq # Equal
	# -ne # Not equal
	# -lt # Less than
	# -le # Less than or equal
	# -gt # Greater than
	# -ge # Greater than or equal
	dateOld="1630436299" # dia que foi feito este script
	dateNow=`busybox date +%s` # data atual no momento do boot
	if [ "$dateOld" -gt "$dateNow" ];then
		echo "ADM DEBUG ### ntp update fail" >> "$Log"
		FORCEClockUpdateNow
	fi
}

# como a box vai saber que esta ligando a partir de um wakeup?
# se aguardar uma hora baseado no time deste script apos retornar do sleep a box vai ficar quase uma hora com horario errado!
# se ficar dando ping no horario a cada um minuto vai estourar a banda do serviço update time
# preciso descobrir qual script que rodar apos o wakeup da box
function FNCheckifSleep () {
CheckifSleep=`dumpsys power | grep "mLastSleepTime=" | cut -d "=" -f 2 | cut -d " " -f 1`
if [ ! "$CheckifSleep" == "0" ]; then
	if [ ! -f "/data/trueDT/peer/TMP/mLastSleepTime/$CheckifSleep" ]; then
		echo "ADM DEBUG ##########################################################################################" >> "$Log"
		echo "ADM DEBUG ### {function FNCheckifSleep} " >> "$Log"
		echo "ADM DEBUG ### Tvbox retornou do mLastSleepTime" >> "$Log"
		echo "ADM DEBUG ### Sincronizar o horario via url" >> "$Log"
		FORCEClockUpdateNow
		# bem provavel que a box com a hora certa detecte o arquivo PidProcess como antigo
		# assim a box chamaria o Boot Oficial UpdateSystem.sh apos um wakeup
		echo "ADM DEBUG ##########################################################################################" >> "$Log"
		echo "ADM DEBUG ### mensagem de alerta para usuário após o wakeup" >> "$Log"
		# * carregar um url do telegram e jogar na tela ?

		mkdir -p "/data/trueDT/peer/TMP/mLastSleepTime"
		echo "Wake from sleep $(busybox date +%s) => $(busybox date +"%d/%m/%Y %H:%M:%S")" > "/data/trueDT/peer/TMP/mLastSleepTime/$CheckifSleep"
	fi
else
	if [ -d "/data/trueDT/peer/TMP/mLastSleepTime" ]; then
		busybox rm -rf "/data/trueDT/peer/TMP/mLastSleepTime"
	fi
fi
}


function checkPidTime () {
	# se a box fizer reboot o arquivo pid do ultimo uso sera mais novo que a data do boot frio fazendo o boot demorar o tempo estipulado no -mmin
	# se o arquivo pid exist e tem uma vida util X tempo então apaga para o gatilho do update lançar nova instancia
	# esta função depende que o relogio esteja correto pois as box vem com data em ( epoch 35 => 31/12/1969 21:00:35 )
	# mesmo que a box esteja em 1969 o pid file apos viver x tempo vai apagar para gerar gatilho
	# no valor -mmin define o tempo que quero fixar a busca do updateSystem.sh
	if [ -f "$PidProcess" ]; then
		Folder="/data/trueDT/peer/TMP"
		SearchFile="init.update.boot.PID"
		/system/bin/busybox find "$Folder" -maxdepth 1 -type f -name "$SearchFile" -mmin +60 | while read File; do
			mv "$File" "$File.OLD"
			echo "ADM DEBUG ##########################################################################################" > "$Log"
			echo "ADM DEBUG ### {function checkPidTime} " >> "$Log"
			echo "ADM DEBUG ### $(busybox date +%s) => $(busybox date +"%d/%m/%Y %H:%M:%S") new loop time" >> "$Log"
			echo "ADM DEBUG ### $(busybox ps aux | grep "init.update.boot.sh" | busybox grep -v grep)" >> "$Log"
		done
	fi
}


function checkPidProcess () {
	# se não existir o arquivo PID inicia o serviço proposto
	if [ ! -f "$PidProcess" ]; then
		echo "" >> "$PidProcess"
		echo "$(busybox date +%s) => $(busybox date +"%d/%m/%Y %H:%M:%S") Start service..." >> "$PidProcess"		
		/system/bin/busybox ps aux | grep "init.update.boot.sh" | /system/bin/busybox grep -v grep >> "$PidProcess"
		echo "------ cat uptime $(busybox cat /proc/uptime | busybox cut -d " " -f 2 | busybox cut -d "." -f 1) --------" >> "$PidProcess"
		# log debug
		echo "ADM DEBUG ##########################################################################################" >> "$Log"
		echo "ADM DEBUG ### {function checkPidProcess} [ start script boot ] " >> "$Log"
		echo "ADM DEBUG ### $(busybox date +%s) => $(busybox date +"%d/%m/%Y %H:%M:%S") Start service UpdateSystem . cat uptime $(busybox cat /proc/uptime | busybox cut -d " " -f 2 | busybox cut -d "." -f 1)" >> "$Log"
		echo "ADM DEBUG ### $(busybox ps aux | grep "init.update.boot.sh" | busybox grep -v grep)" >> "$Log"
		echo "ADM DEBUG ### ------ abaixo faria um screen call do script de boot update --------" >> "$Log"
		# marcador digital de boot completo
		echo "First cold boot completed = $(busybox date +"%d/%m/%Y %H:%M:%S")" > "/data/trueDT/peer/TMP/First Cold Boot.log"
		#########################################################
		# abaixo é debug teste
	else
		# todas as linhas > ADM DEBUG ### são apagadas pelo cleaner	
		# aqui defino quanto tempo quero que este processo trave
		# o init service chama o script a cada 5 segundos em média
		#sleep 60
		sleep 1
		# echo "ADM DEBUG ##########################################################################################" >> "$Log"
		# echo "ADM DEBUG ### {function checkPidProcess} [ wait 1 hour to restart boot update ] " >> "$Log"
		# echo "ADM DEBUG ### $(busybox date +%s) => $(busybox date +"%d/%m/%Y %H:%M:%S")" >> "$Log"
		# echo "ADM DEBUG ### $(busybox ps aux | busybox grep "init.update.boot.sh" | busybox grep -v grep)" >> "$Log"
		# echo "ADM DEBUG ### ------ Script updateSystem já foi iniciado e executado. cat uptime $(busybox cat /proc/uptime | busybox cut -d " " -f 2 | busybox cut -d "." -f 1) --------" >> "$Log"
		# echo "ADM DEBUG ### ------ Proxima ronda de update a cada uma hora a partir do pidFile --------" >> "$Log"
	fi
}


# verificar por md5sum o config do launcher
busybox sha256sum /data/data/dxidev.toptvlauncher2/shared_prefs/PREFERENCE_DATA.xml

FNcheckUptime
FNCheckifSleep


dumpsys power | grep "mLastSleepTime=" | cut -d "=" -f 2 | cut -d " " -f 1

exit

# loop infinito para manter o sistema na mesma porta PID
while [ 1 ]; do
	FNcheckUptime
	FNCheckifSleep
	checkPidTime
	checkPidProcess
done















exit

df -h





